<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Scraper Agent | Interface</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background: radial-gradient(circle at top left, #1a1a2e, #16213e, #0f3460);
            min-height: 100vh;
        }

        .glass {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.08);
        }

        .glass-strong {
            background: rgba(255, 255, 255, 0.08);
            backdrop-filter: blur(24px);
            -webkit-backdrop-filter: blur(24px);
            border: 1px solid rgba(255, 255, 255, 0.12);
        }

        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }

        .scrollbar-thin::-webkit-scrollbar { width: 4px; }
        .scrollbar-thin::-webkit-scrollbar-track { background: transparent; }
        .scrollbar-thin::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.1); border-radius: 4px; }
        .scrollbar-thin::-webkit-scrollbar-thumb:hover { background: rgba(255,255,255,0.2); }

        @keyframes pulse-soft {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.4; }
        }
        .animate-pulse-soft { animation: pulse-soft 2s ease-in-out infinite; }

        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-8px); }
        }
        .animate-float { animation: float 3s ease-in-out infinite; }

        @keyframes slideUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-slide-up { animation: slideUp 0.4s ease-out forwards; }

        @keyframes slideDown {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-slide-down { animation: slideDown 0.3s ease-out forwards; }

        @keyframes fadeInScale {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }
        .animate-fade-scale { animation: fadeInScale 0.3s ease-out forwards; }

        @keyframes typing {
            0% { opacity: 0.3; }
            50% { opacity: 1; }
            100% { opacity: 0.3; }
        }
        .typing-dot { animation: typing 1.4s infinite; }
        .typing-dot:nth-child(2) { animation-delay: 0.2s; }
        .typing-dot:nth-child(3) { animation-delay: 0.4s; }

        @keyframes gradient-shift {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        .animate-gradient {
            background-size: 200% 200%;
            animation: gradient-shift 3s ease infinite;
        }

        @keyframes orbit {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .glow-blue { box-shadow: 0 0 30px rgba(59, 130, 246, 0.15); }
        .glow-purple { box-shadow: 0 0 30px rgba(139, 92, 246, 0.15); }

        .pipeline-item {
            transition: all 0.2s ease;
        }
        .pipeline-item:hover {
            background: rgba(255, 255, 255, 0.06);
            transform: translateX(4px);
        }
        .pipeline-item.selected {
            background: rgba(59, 130, 246, 0.12);
            border-left: 3px solid #3b82f6;
        }
    </style>
</head>
<body class="text-gray-100 flex items-center justify-center p-4 overflow-hidden">

    <!-- ============================================= -->
    <!-- LANDING PAGE -->
    <!-- ============================================= -->
    <div id="landing-page" class="text-center">
        <div class="animate-float mb-8">
            <div class="w-20 h-20 mx-auto rounded-2xl bg-gradient-to-tr from-blue-500 to-purple-600 flex items-center justify-center shadow-lg glow-blue">
                <i data-lucide="bot" class="text-white w-10 h-10"></i>
            </div>
        </div>
        <h1 class="text-5xl md:text-6xl font-extrabold mb-4 bg-clip-text text-transparent bg-gradient-to-r from-blue-400 via-purple-400 to-blue-500 animate-gradient leading-tight">
            Analise sites com IA
        </h1>
        <p class="text-gray-400 text-lg mb-10 max-w-lg mx-auto">
            Transforme qualquer URL em conhecimento conversacional em segundos.
        </p>
        <div class="flex flex-col sm:flex-row gap-4 justify-center">
            <button onclick="openNewModal()" class="bg-gradient-to-r from-blue-500 to-purple-600 hover:from-blue-600 hover:to-purple-700 text-white font-semibold py-3.5 px-8 rounded-full transition-all transform hover:scale-105 shadow-lg flex items-center gap-2.5 justify-center">
                <i data-lucide="zap" class="w-5 h-5"></i> Novo Site
            </button>
            <button onclick="openExistingModal()" class="glass hover:bg-white/10 text-white font-semibold py-3.5 px-8 rounded-full transition-all transform hover:scale-105 flex items-center gap-2.5 justify-center">
                <i data-lucide="database" class="w-5 h-5"></i> Sites Processados
            </button>
        </div>
    </div>

    <!-- ============================================= -->
    <!-- MODAL: NOVA URL -->
    <!-- ============================================= -->
    <div id="new-modal" class="fixed inset-0 z-50 flex items-center justify-center hidden bg-black/60 backdrop-blur-sm">
        <div class="glass-strong w-full max-w-md p-8 rounded-3xl shadow-2xl transform transition-all duration-300 scale-95 opacity-0" id="new-modal-box">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-semibold flex items-center gap-2.5">
                    <div class="w-8 h-8 rounded-lg bg-gradient-to-tr from-blue-500 to-purple-600 flex items-center justify-center">
                        <i data-lucide="link" class="text-white w-4 h-4"></i>
                    </div>
                    Analisar URL
                </h2>
                <button onclick="closeNewModal()" class="text-gray-400 hover:text-white transition-colors p-1">
                    <i data-lucide="x" class="w-5 h-5"></i>
                </button>
            </div>
            <p class="text-gray-400 mb-6 text-sm leading-relaxed">
                Insira o link do site que deseja analisar. Nosso agente processara todo o conteudo e criara uma base de conhecimento inteligente.
            </p>
            <div class="space-y-4">
                <div class="relative">
                    <i data-lucide="globe" class="absolute left-4 top-1/2 -translate-y-1/2 w-4 h-4 text-gray-500"></i>
                    <input type="url" id="url-input" placeholder="https://exemplo.com.br"
                        class="w-full bg-black/40 border border-gray-700 rounded-xl py-3.5 pl-11 pr-4 focus:outline-none focus:ring-2 focus:ring-blue-500/50 focus:border-blue-500 transition-all text-gray-200 placeholder-gray-600">
                </div>
                <button onclick="startPipeline()" id="submit-btn"
                    class="w-full bg-gradient-to-r from-blue-500 to-purple-600 py-3.5 rounded-xl font-bold hover:opacity-90 transition-all flex items-center justify-center gap-2 shadow-lg">
                    <i data-lucide="rocket" class="w-4 h-4"></i>
                    Processar Site
                </button>
            </div>
        </div>
    </div>

    <!-- ============================================= -->
    <!-- MODAL: SITES JA PROCESSADOS -->
    <!-- ============================================= -->
    <div id="existing-modal" class="fixed inset-0 z-50 flex items-center justify-center hidden bg-black/60 backdrop-blur-sm">
        <div class="glass-strong w-full max-w-md p-8 rounded-3xl shadow-2xl transform transition-all duration-300 scale-95 opacity-0" id="existing-modal-box">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-semibold flex items-center gap-2.5">
                    <div class="w-8 h-8 rounded-lg bg-gradient-to-tr from-emerald-500 to-teal-600 flex items-center justify-center">
                        <i data-lucide="database" class="text-white w-4 h-4"></i>
                    </div>
                    Sites Processados
                </h2>
                <button onclick="closeExistingModal()" class="text-gray-400 hover:text-white transition-colors p-1">
                    <i data-lucide="x" class="w-5 h-5"></i>
                </button>
            </div>
            <p class="text-gray-400 mb-5 text-sm">Selecione um site ja processado para iniciar uma conversa.</p>
            <div id="pipelines-list" class="max-h-72 overflow-y-auto rounded-xl border border-white/10 scrollbar-thin mb-2">
                <div class="flex items-center justify-center py-12 text-gray-500">
                    <div class="animate-spin w-5 h-5 border-2 border-gray-500 border-t-blue-400 rounded-full mr-3"></div>
                    Carregando...
                </div>
            </div>
        </div>
    </div>

    <!-- ============================================= -->
    <!-- TELA DE LOADING (SCRAPING) -->
    <!-- ============================================= -->
    <div id="loading-screen" class="hidden fixed inset-0 z-[60] flex flex-col items-center justify-center bg-slate-950/95 backdrop-blur-sm">
        <div class="relative w-28 h-28 mb-8">
            <div class="absolute inset-0 border-4 border-blue-500/10 rounded-full"></div>
            <div class="absolute inset-0 border-4 border-t-blue-500 border-r-purple-500 rounded-full" style="animation: orbit 1.2s linear infinite;"></div>
            <div class="absolute inset-3 border-4 border-t-purple-400 border-l-blue-400 rounded-full" style="animation: orbit 1.8s linear infinite reverse;"></div>
            <i data-lucide="search" class="absolute inset-0 m-auto text-blue-400 w-8 h-8 animate-pulse"></i>
        </div>
        <h3 class="text-xl font-semibold mb-2 text-white" id="loading-status">Iniciando processamento...</h3>
        <p class="text-gray-500 text-sm animate-pulse-soft">Isso pode levar alguns segundos.</p>
        <div class="mt-8 flex gap-1.5">
            <div class="w-2 h-2 rounded-full bg-blue-400 typing-dot"></div>
            <div class="w-2 h-2 rounded-full bg-purple-400 typing-dot"></div>
            <div class="w-2 h-2 rounded-full bg-blue-400 typing-dot"></div>
        </div>
    </div>

    <!-- ============================================= -->
    <!-- CHAT INTERFACE -->
    <!-- ============================================= -->
    <div id="chat-interface" class="hidden fixed inset-0 z-40 p-3 md:p-6 flex items-center justify-center">
        <div class="glass-strong w-full max-w-5xl h-full rounded-3xl overflow-hidden flex flex-col shadow-2xl glow-blue">

            <!-- Header -->
            <div class="px-5 py-4 border-b border-white/10 flex items-center justify-between bg-white/5">
                <div class="flex items-center gap-4">
                    <div class="w-11 h-11 rounded-full bg-gradient-to-tr from-blue-500 to-purple-600 flex items-center justify-center shadow-md">
                        <i data-lucide="bot" class="text-white w-6 h-6"></i>
                    </div>
                    <div>
                        <h4 class="font-semibold text-sm text-white">Agente Conversacional</h4>
                        <div class="flex items-center gap-1.5">
                            <span class="w-2 h-2 bg-emerald-400 rounded-full animate-pulse"></span>
                            <span class="text-xs text-gray-400" id="chat-active-url">conectado</span>
                        </div>
                    </div>
                </div>
                <button onclick="resetApp()" class="text-xs text-gray-400 hover:text-white flex items-center gap-1.5 border border-white/10 px-3.5 py-2 rounded-xl hover:bg-white/5 transition-all">
                    <i data-lucide="refresh-cw" class="w-3.5 h-3.5"></i> Novo Site
                </button>
            </div>

            <!-- Mensagens -->
            <div id="chat-messages" class="flex-1 overflow-y-auto px-5 py-6 space-y-5 scrollbar-thin">
            </div>

            <!-- Input -->
            <div class="px-5 py-4 bg-white/5 border-t border-white/10">
                <div class="relative flex items-center">
                    <input type="text" id="chat-input" placeholder="Pergunte qualquer coisa sobre o site..."
                        class="w-full bg-black/30 border border-white/10 rounded-2xl py-4 px-5 pr-14 focus:outline-none focus:ring-2 focus:ring-blue-500/40 focus:border-blue-500/50 transition-all text-gray-200 placeholder-gray-600 text-sm"
                        disabled>
                    <button onclick="sendMessage()" id="send-btn" disabled
                        class="absolute right-2.5 p-2.5 bg-gradient-to-r from-blue-500 to-purple-600 hover:from-blue-600 hover:to-purple-700 rounded-xl transition-all disabled:opacity-30 disabled:cursor-not-allowed shadow-md">
                        <i data-lucide="send" class="w-4 h-4 text-white"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- ============================================= -->
    <!-- JAVASCRIPT -->
    <!-- ============================================= -->
    <script>
        lucide.createIcons();

        const API_BASE = '';
        let currentIdConta = null;
        let currentUrl = '';
        let availablePipelines = [];

        // === ELEMENTOS ===
        const landingPage = document.getElementById('landing-page');
        const newModal = document.getElementById('new-modal');
        const newModalBox = document.getElementById('new-modal-box');
        const existingModal = document.getElementById('existing-modal');
        const existingModalBox = document.getElementById('existing-modal-box');
        const loadingScreen = document.getElementById('loading-screen');
        const chatInterface = document.getElementById('chat-interface');
        const chatMessages = document.getElementById('chat-messages');
        const chatInput = document.getElementById('chat-input');
        const sendBtn = document.getElementById('send-btn');
        const chatActiveUrl = document.getElementById('chat-active-url');

        // === MODAL HELPERS ===
        function showModal(modal, box) {
            modal.classList.remove('hidden');
            requestAnimationFrame(() => {
                box.classList.remove('scale-95', 'opacity-0');
                box.classList.add('scale-100', 'opacity-100');
            });
        }

        function hideModal(modal, box) {
            box.classList.add('scale-95', 'opacity-0');
            box.classList.remove('scale-100', 'opacity-100');
            setTimeout(() => modal.classList.add('hidden'), 300);
        }

        function openNewModal() {
            showModal(newModal, newModalBox);
            setTimeout(() => document.getElementById('url-input').focus(), 350);
        }
        function closeNewModal() { hideModal(newModal, newModalBox); }

        function openExistingModal() {
            showModal(existingModal, existingModalBox);
            loadPipelines();
        }
        function closeExistingModal() { hideModal(existingModal, existingModalBox); }

        // Fechar modais clicando fora
        newModal.addEventListener('click', (e) => { if (e.target === newModal) closeNewModal(); });
        existingModal.addEventListener('click', (e) => { if (e.target === existingModal) closeExistingModal(); });

        // Enter no input de URL
        document.getElementById('url-input').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') startPipeline();
        });

        // === LOADING STATUS ===
        const loadingStatuses = [
            "Acessando servidor remoto...",
            "Lendo estrutura HTML...",
            "Extraindo conteudo textual...",
            "Convertendo para Markdown...",
            "Processando com IA...",
            "Gerando base de conhecimento...",
            "Treinando agente com contexto..."
        ];

        let statusInterval = null;
        function startLoadingAnimation() {
            let i = 0;
            const el = document.getElementById('loading-status');
            el.textContent = loadingStatuses[0];
            statusInterval = setInterval(() => {
                i++;
                if (i < loadingStatuses.length) {
                    el.textContent = loadingStatuses[i];
                } else {
                    i = 0; // loop
                }
            }, 2500);
        }
        function stopLoadingAnimation() {
            if (statusInterval) clearInterval(statusInterval);
        }

        // === PIPELINE (NOVO SITE) ===
        async function startPipeline() {
            const urlInput = document.getElementById('url-input');
            const url = urlInput.value.trim();
            const btn = document.getElementById('submit-btn');

            if (!url) {
                urlInput.classList.add('ring-2', 'ring-red-500/50');
                setTimeout(() => urlInput.classList.remove('ring-2', 'ring-red-500/50'), 2000);
                return;
            }

            currentUrl = url;
            btn.disabled = true;
            btn.innerHTML = '<div class="animate-spin w-4 h-4 border-2 border-white border-t-transparent rounded-full"></div> Processando...';

            closeNewModal();
            setTimeout(() => {
                landingPage.classList.add('hidden');
                loadingScreen.classList.remove('hidden');
                startLoadingAnimation();
            }, 400);

            try {
                const response = await fetch(`${API_BASE}/api/pipeline`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ url, table: 'marketing_rag', clear: false })
                });

                const data = await response.json();

                if (!response.ok || !data.success) {
                    throw new Error(data.detail || data.message || 'Erro no pipeline');
                }

                currentIdConta = data.data.ID_Conta;
                let hostname;
                try { hostname = new URL(url).hostname; } catch { hostname = url; }

                stopLoadingAnimation();
                document.getElementById('loading-status').textContent = 'Pronto!';

                setTimeout(() => {
                    loadingScreen.classList.add('hidden');
                    openChat(hostname);
                }, 600);

            } catch (error) {
                stopLoadingAnimation();
                loadingScreen.classList.add('hidden');
                landingPage.classList.remove('hidden');
                alert('Erro ao processar: ' + error.message);
                console.error(error);
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<i data-lucide="rocket" class="w-4 h-4"></i> Processar Site';
                lucide.createIcons();
            }
        }

        // === CARREGAR PIPELINES EXISTENTES ===
        async function loadPipelines() {
            const list = document.getElementById('pipelines-list');
            list.innerHTML = `
                <div class="flex items-center justify-center py-12 text-gray-500 text-sm">
                    <div class="animate-spin w-5 h-5 border-2 border-gray-600 border-t-blue-400 rounded-full mr-3"></div>
                    Carregando bases...
                </div>`;

            try {
                const response = await fetch(`${API_BASE}/api/pipelines`);
                const data = await response.json();

                if (!data.success || !data.data || data.data.length === 0) {
                    list.innerHTML = `
                        <div class="flex flex-col items-center justify-center py-12 text-gray-500">
                            <i data-lucide="inbox" class="w-10 h-10 mb-3 opacity-40"></i>
                            <p class="text-sm">Nenhuma base processada ainda</p>
                            <p class="text-xs text-gray-600 mt-1">Processe um site primeiro</p>
                        </div>`;
                    lucide.createIcons();
                    return;
                }

                availablePipelines = data.data;

                list.innerHTML = availablePipelines.map((p, idx) => `
                    <div class="pipeline-item px-4 py-3.5 border-b border-white/5 cursor-pointer flex items-center justify-between" data-idx="${idx}">
                        <div class="flex items-center gap-3">
                            <div class="w-8 h-8 rounded-lg bg-blue-500/10 flex items-center justify-center flex-shrink-0">
                                <i data-lucide="globe" class="w-4 h-4 text-blue-400"></i>
                            </div>
                            <div>
                                <div class="text-sm font-medium text-gray-200">${p.url_inferido}</div>
                                <div class="text-xs text-gray-500">${p.total_faqs} FAQs disponiveis</div>
                            </div>
                        </div>
                        <i data-lucide="chevron-right" class="w-4 h-4 text-gray-600"></i>
                    </div>
                `).join('');

                lucide.createIcons();

                document.querySelectorAll('.pipeline-item').forEach(item => {
                    item.addEventListener('click', () => {
                        const idx = parseInt(item.dataset.idx);
                        const pipeline = availablePipelines[idx];
                        currentIdConta = pipeline.ID_Conta;
                        currentUrl = pipeline.url_inferido;

                        closeExistingModal();
                        setTimeout(() => {
                            landingPage.classList.add('hidden');
                            openChat(pipeline.url_inferido);
                        }, 400);
                    });
                });

            } catch (error) {
                list.innerHTML = `
                    <div class="flex flex-col items-center justify-center py-12 text-red-400">
                        <i data-lucide="alert-circle" class="w-10 h-10 mb-3 opacity-60"></i>
                        <p class="text-sm">Erro ao carregar</p>
                        <p class="text-xs text-gray-500 mt-1">${error.message}</p>
                    </div>`;
                lucide.createIcons();
            }
        }

        // === ABRIR CHAT ===
        function openChat(siteUrl) {
            chatActiveUrl.textContent = siteUrl;
            chatInterface.classList.remove('hidden');
            chatInput.disabled = false;
            sendBtn.disabled = false;
            document.body.style.overflow = 'hidden';

            chatMessages.innerHTML = '';

            // Mensagem de sistema
            appendSystemMessage(`Agente pronto! Analisei todo o conteudo de ${siteUrl}`);

            // Mensagem de boas-vindas do bot
            setTimeout(() => {
                appendBotMessage('Ola! Eu processei o site com sucesso e ja entendo todo o contexto, servicos e informacoes disponiveis. Como posso te ajudar?');
            }, 500);

            setTimeout(() => chatInput.focus(), 600);
        }

        // === MENSAGENS DO CHAT ===
        function appendSystemMessage(text) {
            const div = document.createElement('div');
            div.className = 'flex justify-center my-3 animate-slide-down';
            div.innerHTML = `
                <span class="text-xs bg-blue-500/10 text-blue-400 px-4 py-1.5 rounded-full border border-blue-500/20">
                    ${text}
                </span>`;
            chatMessages.appendChild(div);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function appendUserMessage(text) {
            const div = document.createElement('div');
            div.className = 'flex flex-row-reverse gap-3 max-w-[80%] ml-auto animate-slide-up';
            div.innerHTML = `
                <div class="w-8 h-8 rounded-full bg-blue-500 flex-shrink-0 flex items-center justify-center shadow-md">
                    <i data-lucide="user" class="w-4 h-4 text-white"></i>
                </div>
                <div class="bg-blue-600/80 backdrop-blur-sm p-4 rounded-2xl rounded-tr-none text-sm text-gray-100 shadow-lg">
                    ${escapeHtml(text)}
                </div>`;
            chatMessages.appendChild(div);
            lucide.createIcons();
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function appendBotMessage(text) {
            const div = document.createElement('div');
            div.className = 'flex gap-3 max-w-[80%] animate-slide-up';
            div.innerHTML = `
                <div class="w-8 h-8 rounded-full bg-gray-700 flex-shrink-0 flex items-center justify-center shadow-md">
                    <i data-lucide="bot" class="w-4 h-4 text-white"></i>
                </div>
                <div class="bg-white/10 backdrop-blur-sm p-4 rounded-2xl rounded-tl-none text-sm text-gray-200 shadow-lg">
                    ${escapeHtml(text)}
                </div>`;
            chatMessages.appendChild(div);
            lucide.createIcons();
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function showTypingIndicator() {
            const div = document.createElement('div');
            div.id = 'typing-indicator';
            div.className = 'flex gap-3 max-w-[80%] animate-slide-up';
            div.innerHTML = `
                <div class="w-8 h-8 rounded-full bg-gray-700 flex-shrink-0 flex items-center justify-center shadow-md">
                    <i data-lucide="bot" class="w-4 h-4 text-white"></i>
                </div>
                <div class="bg-white/10 backdrop-blur-sm px-5 py-4 rounded-2xl rounded-tl-none shadow-lg flex items-center gap-1.5">
                    <div class="w-2 h-2 rounded-full bg-gray-400 typing-dot"></div>
                    <div class="w-2 h-2 rounded-full bg-gray-400 typing-dot"></div>
                    <div class="w-2 h-2 rounded-full bg-gray-400 typing-dot"></div>
                </div>`;
            chatMessages.appendChild(div);
            lucide.createIcons();
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function removeTypingIndicator() {
            const el = document.getElementById('typing-indicator');
            if (el) el.remove();
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // === ENVIAR MENSAGEM ===
        async function sendMessage() {
            const message = chatInput.value.trim();
            if (!message || !currentIdConta) return;

            appendUserMessage(message);
            chatInput.value = '';
            chatInput.disabled = true;
            sendBtn.disabled = true;

            showTypingIndicator();

            try {
                const response = await fetch(`${API_BASE}/api/chat`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message, ID_Conta: currentIdConta })
                });

                const data = await response.json();
                removeTypingIndicator();

                if (!response.ok || !data.success) {
                    throw new Error(data.detail || 'Erro no chat');
                }

                const reply = data.data.reply || 'Sem resposta do agente';
                appendBotMessage(reply);

            } catch (error) {
                removeTypingIndicator();
                appendSystemMessage('Erro: ' + error.message);
                console.error(error);
            } finally {
                chatInput.disabled = false;
                sendBtn.disabled = false;
                chatInput.focus();
            }
        }

        // Enter para enviar
        chatInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') sendMessage();
        });

        // === RESET ===
        function resetApp() {
            currentIdConta = null;
            currentUrl = '';
            chatInterface.classList.add('hidden');
            landingPage.classList.remove('hidden');
            document.body.style.overflow = '';
            document.getElementById('url-input').value = '';
        }
    </script>
</body>
</html>
